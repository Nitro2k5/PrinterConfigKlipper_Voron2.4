
### - WORK IN PROGRESS - DOES NOT WORK ATM - ###


[gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES]
variable_test_duration:              60    ; test duartion in minutes
variable_report_cycle:               60    ; report temperatures every x seconds

variable_temperature_bed:            90
variable_temperature_extruder:        0

variable_park_toolhead_center:     True
variable_park_toolhead_z_height:    100



# --- DO NOT EDIT BELOW THIS LINE --- #

variable_cancel_test:             False
variable_sensor_count:                0
variable_remaining_time:              0

variable_sensor0_name:               ''
variable_sensor1_name:               ''
variable_sensor2_name:               ''
variable_sensor3_name:               ''
variable_sensor4_name:               ''
variable_sensor5_name:               ''
variable_sensor6_name:               ''
variable_sensor7_name:               ''
variable_sensor8_name:               ''
variable_sensor9_name:               ''

variable_timesplit1_reading:          0
variable_timesplit2_reading:          0
variable_timesplit3_reading:          0
variable_timesplit4_reading:          0
variable_timesplit5_reading:          0

variable_sensor0_reading0_value:      0
variable_sensor0_reading1_value:      0
variable_sensor0_reading2_va1ue:      0
variable_sensor0_reading3_value:      0
variable_sensor0_reading4_value:      0
variable_sensor0_reading5_value:      0
variable_sensor0_reading6_value:      0

variable_sensor1_reading0_value:      0
variable_sensor1_reading1_value:      0
variable_sensor1_reading2_va1ue:      0
variable_sensor1_reading3_value:      0
variable_sensor1_reading4_value:      0
variable_sensor1_reading5_value:      0
variable_sensor1_reading6_value:      0

variable_sensor2_reading0_value:      0
variable_sensor2_reading1_value:      0
variable_sensor2_reading2_va1ue:      0
variable_sensor2_reading3_value:      0
variable_sensor2_reading4_value:      0
variable_sensor2_reading5_value:      0
variable_sensor2_reading6_value:      0

variable_sensor3_reading0_value:      0
variable_sensor3_reading1_value:      0
variable_sensor3_reading2_va1ue:      0
variable_sensor3_reading3_value:      0
variable_sensor3_reading4_value:      0
variable_sensor3_reading5_value:      0
variable_sensor3_reading6_value:      0

variable_sensor4_reading0_value:      0
variable_sensor4_reading1_value:      0
variable_sensor4_reading2_va1ue:      0
variable_sensor4_reading3_value:      0
variable_sensor4_reading4_value:      0
variable_sensor4_reading5_value:      0
variable_sensor4_reading6_value:      0

variable_sensor5_reading0_value:      0
variable_sensor5_reading1_value:      0
variable_sensor5_reading2_va1ue:      0
variable_sensor5_reading3_value:      0
variable_sensor5_reading4_value:      0
variable_sensor5_reading5_value:      0
variable_sensor5_reading6_value:      0

variable_sensor6_reading0_value:      0
variable_sensor6_reading1_value:      0
variable_sensor6_reading2_va1ue:      0
variable_sensor6_reading3_value:      0
variable_sensor6_reading4_value:      0
variable_sensor6_reading5_value:      0
variable_sensor6_reading6_value:      0

variable_sensor7_reading0_value:      0
variable_sensor7_reading1_value:      0
variable_sensor7_reading2_va1ue:      0
variable_sensor7_reading3_value:      0
variable_sensor7_reading4_value:      0
variable_sensor7_reading5_value:      0
variable_sensor7_reading6_value:      0

variable_sensor8_reading0_value:      0
variable_sensor8_reading1_value:      0
variable_sensor8_reading2_va1ue:      0
variable_sensor8_reading3_value:      0
variable_sensor8_reading4_value:      0
variable_sensor8_reading5_value:      0
variable_sensor8_reading6_value:      0

variable_sensor9_reading0_value:      0
variable_sensor9_reading1_value:      0
variable_sensor9_reading2_va1ue:      0
variable_sensor9_reading3_value:      0
variable_sensor9_reading4_value:      0
variable_sensor9_reading5_value:      0
variable_sensor9_reading6_value:      0

gcode:


[gcode_macro HEATSOAK_PERFORMANCE]
description: TEST TEMPSENSORS
gcode:
    #{% set test_duration = params.DUR|default(100)|int %}
    #{% set report_cycle = 60 | int %}   

    {% set temp_sensors = printer['heaters'].available_sensors | sort %}
    {% set sensor_count = temp_sensors | length %}

    {% if [TEST_TIME] < 10 %}
        _HEATSOAK_PERFORMANCE_ERROR MSG="Test duration must be at least 10 minutes..."
    
    {% elif [BED_TEMP] <= 0 %}
        _HEATSOAK_PERFORMANCE_ERROR MSG="Bed temperature must be greater than 0..."
    
    {% else %}
        {action_respond_info(">>>----------------------------------<<<")}
        {action_respond_info("START HEATSOAK PERFORMANCE TEST!")}
        {action_respond_info("----------------------------------------")}
        {action_respond_info("Test duration: %s min" % printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].test_duration)}
        #{action_respond_info("Report cycle: %s sec" % printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].report_cycle)}
        {action_respond_info("----------------------------------------")}

        {action_respond_info("Temperature sensor count: %s" % sensor_count)}
        {action_respond_info("List of available temperature sensors:")}
        {% for i in range(temp_sensors|length) %}
            {action_respond_info("Sensor[%s]: %s" % (i, temp_sensors[i] if i <= 1 else temp_sensors[i][18:] ) )}
        {% endfor %}
        {action_respond_info("----------------------------------------")}

        {% if printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].park_toolhead_center|lower == 'true' %}
            {action_respond_info("> Home all axis <")}
            G28
            {action_respond_info("> Move to center location X%.2f Y%.2f Z%.2f <" % (printer.toolhead.axis_maximum.x//2, printer.toolhead.axis_maximum.y//2, printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].park_toolhead_z_height|float))}
            G0 X{printer.toolhead.axis_maximum.x//2} Y{printer.toolhead.axis_maximum.y//2} Z{printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].park_toolhead_z_height|float} F3000
            {action_respond_info("----------------------------------------")}
        {% endif %}
        
        _HEATSOAK_STORE_RAWNAMES
        
        UPDATE_DELAYED_GCODE ID=_HEATSOAK_PERFORMANCE_REPORTLOOP DURATION=25
        UPDATE_DELAYED_GCODE ID=_HEATSOAK_PERFORMANCE_START DURATION=30
        UPDATE_DELAYED_GCODE ID=_HEATSOAK_PERFORMANCE_READING01_TEMP DURATION={((timesplit1_reading * 60) + 30)}
        UPDATE_DELAYED_GCODE ID=_HEATSOAK_PERFORMANCE_READING02_TEMP DURATION={((timesplit2_reading * 60) + 30)}
        UPDATE_DELAYED_GCODE ID=_HEATSOAK_PERFORMANCE_READING03_TEMP DURATION={((timesplit3_reading * 60) + 30)}
        UPDATE_DELAYED_GCODE ID=_HEATSOAK_PERFORMANCE_READING04_TEMP DURATION={((timesplit4_reading * 60) + 30)}
        {% if timesplit5_reading != 0 %}
            UPDATE_DELAYED_GCODE ID=_HEATSOAK_PERFORMANCE_READING05_TEMP DURATION={((timesplit5_reading * 60) + 30)}
        {% endif %}
        UPDATE_DELAYED_GCODE ID=_HEATSOAK_PERFORMANCE_END DURATION={(([TEST_TIME] * 60) + 30)}
    {% endif %}



[delayed_gcode _HEATSOAK_PERFORMANCE_REPORTLOOP]
gcode:


SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=remaining_time VALUE={[TEST_TIME]}
    	
    	{% if [TEST_TIME] < 30 %}
    	    {% set time_split = [TEST_TIME] / 5 %}
    	    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=timesplit1_reading VALUE={(time_split * 1)}
    	    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=timesplit2_reading VALUE={(time_split * 2)}
    	    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=timesplit3_reading VALUE={(time_split * 3)}
    	    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=timesplit4_reading VALUE={(time_split * 4)}
    	    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=timesplit5_reading VALUE=0
    	{% else %}
    	    {% set time_split = [TEST_TIME] / 6 %}
    	    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=timesplit1_reading VALUE={(time_split * 1)}
    	    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=timesplit2_reading VALUE={(time_split * 2)}
    	    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=timesplit3_reading VALUE={(time_split * 3)}
    	    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=timesplit4_reading VALUE={(time_split * 4)}
    	    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=timesplit5_reading VALUE={(time_split * 5)}
    	{% endif %}
        
        
 [delayed_gcode _HEATSOAK_PERFORMANCE_START]
gcode:
    {% set sensor0_name = printer['gcode_macro HEATSOAK_PERFORMANCE_VARIABLES'].sensor0_name %}
    {% set sensor1_name = printer['gcode_macro HEATSOAK_PERFORMANCE_VARIABLES'].sensor1_name %}
    {% set sensor2_name = printer['gcode_macro HEATSOAK_PERFORMANCE_VARIABLES'].sensor2_name %}
	{% set sensor3_name = printer['gcode_macro HEATSOAK_PERFORMANCE_VARIABLES'].sensor3_name %}
	{% set sensor4_name = printer['gcode_macro HEATSOAK_PERFORMANCE_VARIABLES'].sensor4_name %}
	{% set sensor5_name = printer['gcode_macro HEATSOAK_PERFORMANCE_VARIABLES'].sensor5_name %}
	{% set sensor6_name = printer['gcode_macro HEATSOAK_PERFORMANCE_VARIABLES'].sensor6_name %}
	{% set sensor7_name = printer['gcode_macro HEATSOAK_PERFORMANCE_VARIABLES'].sensor7_name %}
	{% set sensor8_name = printer['gcode_macro HEATSOAK_PERFORMANCE_VARIABLES'].sensor8_name %}
	{% set sensor9_name = printer['gcode_macro HEATSOAK_PERFORMANCE_VARIABLES'].sensor9_name %}
	
	#READ AND SAVE ACUTAL TEMP READINGS UP TO 10 SENSORS
	{% if sensor0_name != '' %}
	    {% set sensor0_temp = printer.[temperature_sensor my_sensor].temperature %}
	    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor0_reading0_value VALUE={sensor0_temp}
	{% endif %}

	{% if sensor1_name != '' %}
	    {% set sensor1_temp = printer.[temperature_sensor my_sensor].temperature %}
	    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor1_reading0_value VALUE={sensor1_temp}
	{% endif %}
	
	{% if sensor2_name != '' %}
	    {% set sensor2_temp = printer.[temperature_sensor my_sensor].temperature %}
	    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor2_reading0_value VALUE={sensor2_temp}
	{% endif %}
	
	{% if sensor3_name != '' %}
	    {% set sensor3_temp = printer.[temperature_sensor my_sensor].temperature %}
	    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor3_reading0_value VALUE={sensor3_temp}
	{% endif %}
	
	{% if sensor4_name != '' %}
	    {% set sensor4_temp = printer.[temperature_sensor my_sensor].temperature %}
	    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor4_reading0_value VALUE={sensor4_temp}
	{% endif %}
	
	{% if sensor5_name != '' %}
	    {% set sensor5_temp = printer.[temperature_sensor my_sensor].temperature %}
	    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor5_reading0_value VALUE={sensor5_temp}
	{% endif %}
	
	{% if sensor6_name != '' %}
	    {% set sensor6_temp = printer.[temperature_sensor my_sensor].temperature %}
	    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor6_reading0_value VALUE={sensor6_temp}
	{% endif %}
	
	{% if sensor7_name != '' %}
	    {% set sensor7_temp = printer.[temperature_sensor my_sensor].temperature %}
	    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor7_reading0_value VALUE={sensor7_temp}
	{% endif %}
	
	{% if sensor8_name != '' %}
	    {% set sensor8_temp = printer.[temperature_sensor my_sensor].temperature %}
	    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor8_reading0_value VALUE={sensor8_temp}
	{% endif %}
	
	{% if sensor9_name != '' %}
	    {% set sensor9_temp = printer.[temperature_sensor my_sensor].temperature %}
	    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor9_reading0_value VALUE={sensor9_temp}
	{% endif %}
	
	
	{% set extruder_temp = printer['gcode_macro HEATSOAK_PERFORMANCE_VARIABLES'].extruder_temp %}
	{% set bed_temp = printer['gcode_macro HEATSOAK_PERFORMANCE_VARIABLES'].bed_temp %}
	
	{% if extruder_temp > 0 %}
	    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={extruder_temp} ;falsch
	{% endif %}
	
    {% if bed_temp > 0 %}
	    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp} ;falsch
	{% endif %}
        



[gcode_macro _HEATSOAK_STORE_RAWNAMES]
gcode:
    {% set temp_sensors = printer['heaters'].available_sensors | sort %}
    {% set sensor_count = temp_sensors | length %}

    SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor_count VALUE='{ sensor_count }'

    {% if sensor_count > 0 %}
        SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor0_name VALUE='"{ temp_sensors[0] }"'
    {% endif %}

    {% if sensor_count > 1 %}
        SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor1_name VALUE='"{ temp_sensors[1] }"'
    {% endif %}

    {% if sensor_count > 2 %}
        SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor2_name VALUE='"{ temp_sensors[2] }"'
    {% endif %}

    {% if sensor_count > 3 %}
        SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor3_name VALUE='"{ temp_sensors[3] }"'
    {% endif
    {% if sensor_count > 4 %}
        SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor4_name VALUE='"{ temp_sensors[4] }"'
    {% endif %}

    {% if sensor_count > 5 %}
        SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor5_name VALUE='"{ temp_sensors[5] }"'
    {% endif %}

    {% if sensor_count > 6 %}
        SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor6_name VALUE='"{ temp_sensors[6] }"'
    {% endif %}

    {% if sensor_count > 7 %}
        SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor7_name VALUE='"{ temp_sensors[7] }"'
    {% endif %}

    {% if sensor_count > 8 %}
        SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor8_name VALUE='"{ temp_sensors[8] }"'
    {% endif %}

    {% if sensor_count > 9 %}
        SET_GCODE_VARIABLE MACRO=_HEATSOAK_PERFORMANCE_VARIABLES VARIABLE=sensor9_name VALUE='"{ temp_sensors[9] }"'
    {% endif


[gcode_macro _HEATSOAK_OUTPUT_RAWNAMES]
gcode:
    {% set sensor_count = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor_count|int %}
    {% set sensor0_name = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor0_name|string %}
    {% set sensor1_name = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor1_name|string %}
    {% set sensor2_name = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor2_name|string %}
    {% set sensor3_name = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor3_name|string %}
    {% set sensor4_name = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor4_name|string %}
    {% set sensor5_name = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor5_name|string %}
    {% set sensor6_name = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor6_name|string %}
    {% set sensor7_name = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor7_name|string %}
    {% set sensor8_name = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor8_name|string %}
    {% set sensor9_name = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor9_name|string %}

    {action_respond_info("Temperature sensor count: %s" % sensor_count)}
    {action_respond_info("List of available temperature sensors:")}
    {% if sensor_count > 0 %} {action_respond_info("%s" % sensor0_name)} {% endif %}
    {% if sensor_count > 1 %} {action_respond_info("%s" % sensor1_name)} {% endif %}
    {% if sensor_count > 2 %} {action_respond_info("%s" % sensor2_name)} {% endif %}
    {% if sensor_count > 3 %} {action_respond_info("%s" % sensor3_name)} {% endif %}
    {% if sensor_count > 4 %} {action_respond_info("%s" % sensor4_name)} {% endif %}
    {% if sensor_count > 5 %} {action_respond_info("%s" % sensor5_name)} {% endif %}
    {% if sensor_count > 6 %} {action_respond_info("%s" % sensor6_name)} {% endif %}
    {% if sensor_count > 7 %} {action_respond_info("%s" % sensor7_name)} {% endif %}
    {% if sensor_count > 8 %} {action_respond_info("%s" % sensor8_name)} {% endif %}
    {% if sensor_count > 9 %} {action_respond_info("%s" % sensor9_name)} {% endif %}


[gcode_macro _HEATSOAK_OUTPUT_SENSORNAMES]
gcode:
    {% set sensor_count = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor_count|int %}
    {% set sensor0_name = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor0_name|string %}
    {% set sensor1_name = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor1_name|string[18:] %}
    {% set sensor2_name = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor2_name|string[18:] %}
    {% set sensor3_name = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor3_name|string[18:] %}
    {% set sensor4_name = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor4_name|string[18:] %}
    {% set sensor5_name = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor5_name|string[18:] %}
    {% set sensor6_name = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor6_name|string[18:] %}
    {% set sensor7_name = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor7_name|string[18:] %}
    {% set sensor8_name = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor8_name|string[18:] %}
    {% set sensor9_name = printer["gcode_macro _HEATSOAK_PERFORMANCE_VARIABLES"].sensor9_name|string[18:] %}

    {action_respond_info("Temperature sensor count: %s" % sensor_count)}
    {action_respond_info("List of available temperature sensors:")}
    {% if sensor_count > 0 %} {action_respond_info("%s" % sensor0_name)} {% endif %}
    {% if sensor_count > 1 %} {action_respond_info("%s" % sensor1_name)} {% endif %}
    {% if sensor_count > 2 %} {action_respond_info("%s" % sensor2_name)} {% endif %}
    {% if sensor_count > 3 %} {action_respond_info("%s" % sensor3_name)} {% endif %}
    {% if sensor_count > 4 %} {action_respond_info("%s" % sensor4_name)} {% endif %}
    {% if sensor_count > 5 %} {action_respond_info("%s" % sensor5_name)} {% endif %}
    {% if sensor_count > 6 %} {action_respond_info("%s" % sensor6_name)} {% endif %}
    {% if sensor_count > 7 %} {action_respond_info("%s" % sensor7_name)} {% endif %}
    {% if sensor_count > 8 %} {action_respond_info("%s" % sensor8_name)} {% endif %}
    {% if sensor_count > 9 %} {action_respond_info("%s" % sensor9_name)} {% endif %}





[gcode_macro _HEATSOAK_PERFORMANCE_ERROR]
gcode:
    {% set MSG = params.MSG|default('NULLMSG')|string %}
    {% if MSG != 'NULLMSG' %}
        {action_respond_info("----------------------------------------")}
        {action_respond_info("HEATSOAK PERFORMANCE ERROR")}
        {action_respond_info("\n")}
        {action_respond_info("%s" % MSG)}
        {action_respond_info("\n")}
        {action_respond_info("CANCEL HEATSOAK PERFORMANCE TEST")}
        {action_respond_info("----------------------------------------")}
    {% endif %}
	
	
